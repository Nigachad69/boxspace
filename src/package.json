"use client";

import React, { useState, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Mail, 
  Phone, 
  MapPin, 
  Send, 
  User, 
  MessageSquare, 
  CheckCircle,
  Clock,
  Briefcase
} from 'lucide-react';
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";
import { useToast } from "@/hooks/use-toast";
import Altcha from '@altcha/react';

const services = [
  { id: "records-management", label: "Records Management" },
  { id: "digitization", label: "Digitization" },
  { id: "business-asset", label: "Business Asset" },
  { id: "ecommerce-fulfillment", label: "Ecommerce Fulfillment" },
  { id: "self-storage-open", label: "Self Storage - Open Flexi" },
  { id: "self-storage-closed", label: "Self Storage - Closed Room" },
  { id: "other", label: "Other" },
] as const;

const formSchema = z.object({
  name: z.string().min(2, { message: "Name must be at least 2 characters." }),
  email: z.string().email({ message: "Please enter a valid email address." }),
  subject: z.string().min(5, { message: "Subject must be at least 5 characters." }),
  services: z.array(z.string()).refine((value) => value.some((item) => item), {
    message: "You have to select at least one service.",
  }),
  message: z.string().min(10, { message: "Message must be at least 10 characters." }),
  altcha: z.string({ required_error: "Verification is required." }),
});

const contactMethods = [
  {
    icon: Phone,
    title: "Phone",
    value: "+91 8591-439-244",
    link: "tel:+918591439244",
  },
  {
    icon: Mail,
    title: "Email",
    value: "ryan@boxspacesolutions.com",
    link: "mailto:ryan@boxspacesolutions.com",
  },
  {
    icon: MapPin,
    title: "Address",
    value: "Block -2, Ground Floor, B Wing, Osho Krishna, Gadrewadi, Vishnu Nagar, Naupada, Thane, Maharashtra, India - 400602",
  }
];

const businessHours = [
    {
      icon: <Clock className="h-6 w-6 text-primary" />,
      day: "Monday - Saturday",
      time: "9am to 6pm",
    },
    {
      icon: <Clock className="h-6 w-6 text-primary" />,
      day: "Sunday",
      time: "Closed",
    },
];

export default function PremiumContactPage() {
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      email: "",
      subject: "",
      services: [],
      message: "",
    },
  });

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setIsSubmitting(true);
    // Simulate API call
    await new Promise(resolve => setTimeout(resolve, 1500));

    console.log(values);
    
    setIsSubmitting(false);
    setIsSubmitted(true);
    
    // Reset form after a delay to show success message
    setTimeout(() => {
        setIsSubmitted(false);
        form.reset();
    }, 4000)
  }

  const fadeInUp = {
    hidden: { opacity: 0, y: 40 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.8, ease: "easeOut" } }
  };

  const staggerContainer = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.15, delayChildren: 0.2 } }
  };

  return (
    <section className="relative py-24 md:py-32 bg-background text-foreground overflow-hidden">
      <div className="absolute inset-0 bg-grid -z-10" />
      <motion.div
        className="absolute top-0 left-0 w-96 h-96 bg-primary/5 rounded-full blur-3xl"
        animate={{ x: [0, 100, 0], y: [0, -50, 0] }}
        transition={{ duration: 20, repeat: Infinity, ease: "easeInOut" }}
      />
      <motion.div
        className="absolute bottom-0 right-0 w-96 h-96 bg-accent/5 rounded-full blur-3xl"
        animate={{ x: [0, -100, 0], y: [0, 50, 0] }}
        transition={{ duration: 25, repeat: Infinity, ease: "easeInOut", delay: 5 }}
      />
      
      <motion.div 
        className="relative z-10 max-w-7xl mx-auto px-4"
        variants={staggerContainer}
        initial="hidden"
        whileInView="visible"
        viewport={{ once: true, amount: 0.1 }}
      >
        <motion.div className="text-center mb-16" variants={fadeInUp}>
          <h1 className="text-4xl sm:text-6xl font-bold mb-4 tracking-tighter">
            Get in <span className="text-primary">Touch</span>
          </h1>
          <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto leading-relaxed">
            Feel free to ask for details, don't save any questions! We're here to help you find the perfect solution.
          </p>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-5 gap-12 items-start">
          <motion.div className="lg:col-span-3" variants={fadeInUp}>
            <AnimatePresence mode="wait">
              {!isSubmitted ? (
                <motion.div
                  key="form"
                  initial={{ opacity: 1 }}
                  exit={{ opacity: 0, y: -20 }}
                  transition={{ duration: 0.3 }}
                >
                  <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormField control={form.control} name="name" render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Full Name *</FormLabel>
                                    <FormControl><div className="relative"><User className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" /><Input {...field} className="pl-10" /></div></FormControl>
                                    <FormMessage />
                                </FormItem>
                            )} />
                            <FormField control={form.control} name="email" render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Email Address *</FormLabel>
                                    <FormControl><div className="relative"><Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" /><Input {...field} className="pl-10" /></div></FormControl>
                                    <FormMessage />
                                </FormItem>
                            )} />
                        </div>

                        <FormField control={form.control} name="subject" render={({ field }) => (
                            <FormItem>
                                <FormLabel>Subject *</FormLabel>
                                <FormControl><div className="relative"><Briefcase className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" /><Input {...field} className="pl-10" /></div></FormControl>
                                <FormMessage />
                            </FormItem>
                        )} />

                        <FormField control={form.control} name="services" render={() => (
                          <FormItem>
                            <FormLabel>Service *</FormLabel>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 pt-2">
                              {services.map((item) => (
                                <FormField key={item.id} control={form.control} name="services" render={({ field }) => (
                                  <FormItem className="flex items-center space-x-2 space-y-0">
                                    <FormControl>
                                      <Checkbox
                                        checked={field.value?.includes(item.id)}
                                        onCheckedChange={(checked) => {
                                          const newValue = checked
                                            ? [...(field.value || []), item.id]
                                            : (field.value || []).filter((value) => value !== item.id);
                                          field.onChange(newValue);
                                        }}
                                      />
                                    </FormControl>
                                    <FormLabel className="font-normal text-sm text-muted-foreground">{item.label}</FormLabel>
                                  </FormItem>
                                )} />
                              ))}
                            </div>
                            <FormMessage />
                          </FormItem>
                        )} />

                        <FormField control={form.control} name="message" render={({ field }) => (
                            <FormItem>
                                <FormLabel>Message *</FormLabel>
                                <FormControl><div className="relative"><MessageSquare className="absolute left-3 top-4 h-5 w-5 text-muted-foreground" /><Textarea {...field} className="pl-10 min-h-[120px]" /></div></FormControl>
                                <FormMessage />
                            </FormItem>
                        )} />

                        <FormField
                          control={form.control}
                          name="altcha"
                          render={({ field }) => (
                            <FormItem>
                              <FormControl>
                                <Altcha
                                  hidelogo
                                  challengeUrl="https://eu.altcha.org/api/v1/challenge"
                                  onStateChange={(s) => {
                                    if (s.state === 'verified') {
                                      field.onChange(s.payload);
                                    }
                                  }}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                            <Button type="submit" disabled={isSubmitting} size="lg" className="w-full">
                                {isSubmitting ? (
                                    <>
                                        <motion.div
                                            className="w-5 h-5 border-2 border-primary-foreground/30 border-t-primary-foreground rounded-full mr-2"
                                            animate={{ rotate: 360 }}
                                            transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                                        />
                                        Sending...
                                    </>
                                ) : (
                                    <>
                                        <Send className="mr-2 h-5 w-5" /> Send Message
                                    </>
                                )}
                            </Button>
                        </motion.div>
                    </form>
                  </Form>
                </motion.div>
              ) : (
                <motion.div
                  key="success"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="text-center flex flex-col items-center justify-center bg-card border border-border rounded-xl p-8 min-h-[500px]"
                >
                  <motion.div
                    className="w-20 h-20 rounded-full bg-green-500/10 border border-green-400/20 flex items-center justify-center mx-auto mb-6"
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ delay: 0.2, type: "spring", stiffness: 200 }}
                  >
                    <CheckCircle className="w-10 h-10 text-green-400" />
                  </motion.div>
                  <h3 className="text-2xl font-bold text-foreground mb-3">Message Sent!</h3>
                  <p className="text-muted-foreground text-lg">
                    Thank you for reaching out. We'll be in touch shortly.
                  </p>
                </motion.div>
              )}
            </AnimatePresence>
          </motion.div>

          <motion.div className="lg:col-span-2 space-y-8" variants={staggerContainer}>
              <motion.div variants={fadeInUp}>
                  <h3 className="text-2xl font-bold text-foreground mb-6">Contact Info</h3>
                  <div className="space-y-6">
                    {contactMethods.map((method, index) => (
                      <motion.a
                        key={index}
                        href={method.link}
                        className="block p-5 bg-card/50 backdrop-blur-sm rounded-xl border border-border hover:border-primary transition-all group"
                        whileHover={{ y: -3, scale: 1.02 }}
                      >
                        <div className="flex items-start gap-4">
                          <div className="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center shrink-0">
                            <method.icon className="w-6 h-6 text-primary" />
                          </div>
                          <div className="flex-1">
                            <h4 className="font-semibold text-foreground mb-1">{method.title}</h4>
                            <p className="text-muted-foreground text-sm break-words">{method.value}</p>
                          </div>
                        </div>
                      </motion.a>
                    ))}
                  </div>
              </motion.div>

              <motion.div variants={fadeInUp}>
                  <h3 className="text-2xl font-bold text-foreground mb-6">Business Hours</h3>
                   <div className="space-y-6">
                    {businessHours.map((item, index) => (
                        <motion.div
                            key={index}
                            className="flex items-start gap-4 p-5 bg-card/50 backdrop-blur-sm rounded-xl border border-border"
                            whileHover={{ y: -3, scale: 1.02 }}
                        >
                            <div className="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center shrink-0">
                                {item.icon}
                            </div>
                            <div>
                                <p className="font-semibold text-foreground">{item.day}</p>
                                <p className="text-muted-foreground text-sm">{item.time}</p>
                            </div>
                        </motion.div>
                    ))}
                   </div>
              </motion.div>
          </motion.div>
        </div>
      </motion.div>
    </section>
  );
}